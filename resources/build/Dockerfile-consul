FROM alpine
MAINTAINER Brandon Okert

RUN LAYER=consul                                 \
  && version=0.5.2 \
  && apk --update add make wget go git gcc musl-dev openssl-dev bash curl \
  && export GOPATH=/go \
  && go get -u -v github.com/hashicorp/consul \
  && cd /go/src/github.com/hashicorp/consul \
  && git checkout v${version} \
  && make \
  && mv bin/consul /bin/ \
  && rm -rf /go \
  && cd /tmp \
  && wget -O ui.zip http://dl.bintray.com/mitchellh/consul/${version}_web_ui.zip \
  && unzip ui.zip \
  && mv dist /ui \
  && rm ui.zip \
  && apk del make wget go git gcc musl-dev openssl-dev bash curl \
  && rm -rf /var/cache/apk/* \
  && mkdir -p /var/log/consul /data

ENV GOMAXPROCS 2

COPY consul.d /etc/consul.d/

COPY consul-server-start.sh /usr/local/bin
RUN chmod a+x /usr/local/bin/consul-server-start.sh

VOLUME /data/consul
VOLUME /var/log/consul

EXPOSE 8300 8301 8301/udp 8302 8302/udp 8400 8500 8600 8600/udp
